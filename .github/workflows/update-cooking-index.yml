name: Update Cooking Index

on:
  push:
    branches:
      - main
    paths:
      - 'cooking/*-timer.html'

jobs:
  update-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate cooking index
        run: |
          cat > cooking/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Cooking Timers</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                color: #fff;
                padding: 24px;
              }
              .back-link {
                display: inline-block;
                color: #00cec9;
                text-decoration: none;
                margin-bottom: 24px;
                font-size: 0.9rem;
              }
              .back-link:hover { text-decoration: underline; }
              h1 { font-size: 2rem; text-align: center; margin-bottom: 8px; }
              .subtitle { text-align: center; opacity: 0.7; margin-bottom: 32px; font-size: 1rem; }
              .timers { max-width: 600px; margin: 0 auto; }
              .timer-card {
                background: #1e3a5f;
                border-radius: 16px;
                padding: 20px;
                margin-bottom: 16px;
                text-decoration: none;
                color: #fff;
                display: block;
                transition: transform 0.2s, box-shadow 0.2s;
              }
              .timer-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 32px rgba(0, 184, 148, 0.2);
              }
              .timer-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; }
              .timer-meta { font-size: 0.9rem; opacity: 0.7; }
              .timer-time {
                display: inline-block;
                background: rgba(0, 184, 148, 0.2);
                color: #00cec9;
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 0.8rem;
                margin-top: 10px;
              }
            </style>
          </head>
          <body>
            <a href="/" class="back-link">‚Üê Back to Home</a>
            <h1>üç≥ Cooking Timers</h1>
            <p class="subtitle">Step-by-step timers for complex recipes</p>
            <div class="timers">
          HTMLEOF

          # Loop through all timer files and extract info
          for file in cooking/*-timer.html; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              
              # Extract title (text between <title> tags, remove " Timer" suffix)
              title=$(grep -o '<title>[^<]*</title>' "$file" | sed 's/<[^>]*>//g' | sed 's/ Timer$//')
              
              # Extract recipe credit line (usually in .recipe-credit div)
              credit=$(grep -o 'class="recipe-credit">[^<]*<' "$file" | sed 's/class="recipe-credit">//' | sed 's/<$//' | head -1)
              
              # If no credit found, try to extract from other patterns
              if [ -z "$credit" ]; then
                credit=$(grep -oP '(?<=<div class="recipe-credit">)[^<]+' "$file" | head -1)
              fi
              
              # Extract time estimate (look for pattern like "~X hours" or "~X min")
              time_est=$(grep -oE '~[0-9.]+ (hours?|min(utes?)?)( total)?' "$file" | head -1)
              if [ -z "$time_est" ]; then
                time_est="See recipe"
              fi
              
              # Determine emoji based on filename
              emoji="üç≥"
              case "$filename" in
                *rib*) emoji="üçñ" ;;
                *steak*|*ribeye*) emoji="ü•©" ;;
                *chicken*) emoji="üçó" ;;
                *fish*|*salmon*) emoji="üêü" ;;
                *pork*) emoji="üê∑" ;;
                *beef*) emoji="ü•©" ;;
                *pasta*) emoji="üçù" ;;
                *bread*) emoji="üçû" ;;
                *cake*|*dessert*) emoji="üç∞" ;;
              esac
              
              # Add timer card to index
              cat >> cooking/index.html << CARDEOF
              <a href="$filename" class="timer-card">
                <div class="timer-title">$emoji $title</div>
                <div class="timer-meta">$credit</div>
                <span class="timer-time">$time_est</span>
              </a>
          CARDEOF
            fi
          done

          # Close the HTML
          cat >> cooking/index.html << 'HTMLEOF'
            </div>
          </body>
          </html>
          HTMLEOF

      - name: Commit changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add cooking/index.html
          git diff --staged --quiet || git commit -m "Auto-update cooking index"
          git push
